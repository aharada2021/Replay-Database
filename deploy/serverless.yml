service: wows-replay-bot

frameworkVersion: '3'

provider:
  name: aws
  region: ap-northeast-1
  # Dockerイメージを使用する場合、runtimeは不要（個別関数で指定）
  stage: ${opt:stage, 'dev'}

  # HTTP API CORS設定
  httpApi:
    cors:
      allowedOrigins:
        - ${env:FRONTEND_URL}
        - http://localhost:3000
      allowedHeaders:
        - Content-Type
        - X-Api-Key
        - X-User-Id
        - Cookie
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: true

  # 環境変数
  environment:
    DISCORD_PUBLIC_KEY: ${env:DISCORD_PUBLIC_KEY}
    DISCORD_APPLICATION_ID: ${env:DISCORD_APPLICATION_ID}
    DISCORD_BOT_TOKEN: ${env:DISCORD_BOT_TOKEN}
    INPUT_CHANNEL_ID: ${env:INPUT_CHANNEL_ID}
    GUILD_ID: ${env:GUILD_ID}
    STAGE: ${self:provider.stage}

  # IAMロール
  iam:
    role:
      statements:
        # S3アクセス（一時ファイル保存用）
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
          Resource:
            - arn:aws:s3:::${self:custom.bucketName}/*

        # CloudWatch Logs
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'

        # Lambda呼び出し
        # interactions → replay-analyzer → video-generator
        # battle-result-extractor → generate-video-api
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource:
            - arn:aws:lambda:${self:provider.region}:*:function:${self:service}-${self:provider.stage}-replay-analyzer
            - arn:aws:lambda:${self:provider.region}:*:function:${self:service}-${self:provider.stage}-video-generator
            - arn:aws:lambda:${self:provider.region}:*:function:${self:service}-${self:provider.stage}-generate-video-api

        # DynamoDB アクセス
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:BatchWriteItem
            - dynamodb:BatchGetItem
          Resource:
            # 旧テーブル（移行完了後に削除予定）
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.replaysTable}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.replaysTable}/index/*
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.shipMatchIndexTable}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.shipMatchIndexTable}/index/*
            # 新バトルテーブル
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.clanBattlesTable}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.clanBattlesTable}/index/*
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.rankedBattlesTable}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.rankedBattlesTable}/index/*
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.randomBattlesTable}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.randomBattlesTable}/index/*
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.otherBattlesTable}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.otherBattlesTable}/index/*
            # 新インデックステーブル
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.shipIndexTable}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.playerIndexTable}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.clanIndexTable}
            # その他テーブル
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.sessionsTable}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.commentsTable}

# カスタム変数
custom:
  bucketName: wows-replay-bot-${self:provider.stage}-temp
  # 旧テーブル（移行完了後に削除予定）
  replaysTable: wows-replays-${self:provider.stage}
  shipMatchIndexTable: wows-ship-match-index-${self:provider.stage}
  # 新バトルテーブル（gameType別）
  clanBattlesTable: wows-clan-battles-${self:provider.stage}
  rankedBattlesTable: wows-ranked-battles-${self:provider.stage}
  randomBattlesTable: wows-random-battles-${self:provider.stage}
  otherBattlesTable: wows-other-battles-${self:provider.stage}
  # 新インデックステーブル
  shipIndexTable: wows-ship-index-${self:provider.stage}
  playerIndexTable: wows-player-index-${self:provider.stage}
  clanIndexTable: wows-clan-index-${self:provider.stage}
  # その他テーブル
  sessionsTable: wows-sessions-${self:provider.stage}
  commentsTable: wows-comments-${self:provider.stage}
  # 開発環境でのみ艦長スキルデバッグを有効化
  debugCaptainSkills:
    dev: 'true'
    prod: 'false'
  # Dockerイメージを使用するため、pythonRequirementsは不要
  # pythonRequirements:
  #   dockerizePip: true
  #   layer: true

functions:
  # ========================================
  # Extractorイメージを使用する関数群（メタデータ解析など）
  # ========================================

  # Discord Interactions Endpoint
  interactions:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.discord.interactions.handle_interaction
    architecture: arm64
    timeout: 30  # 30秒（軽量な処理のみ）
    memorySize: 256  # 256MB（コマンド受信と非同期呼び出しのみ）
    events:
      - httpApi:
          path: /interactions
          method: post
    environment:
      TEMP_BUCKET: ${self:custom.bucketName}
      REPLAY_ANALYZER_FUNCTION_NAME: ${self:service}-${self:provider.stage}-replay-analyzer

  # リプレイ解析用Lambda関数（extractor環境）
  replay-analyzer:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.processing.replay_analyzer.handle
    architecture: arm64
    timeout: 300  # 5分（メタデータ解析のみ）
    memorySize: 512
    environment:
      TEMP_BUCKET: ${self:custom.bucketName}
      VIDEO_GENERATOR_FUNCTION_NAME: ${self:service}-${self:provider.stage}-video-generator

  # ========================================
  # Processorイメージを使用する関数群（renderer依存）
  # ========================================

  # 動画生成用Lambda関数（processor環境）
  video-generator:
    image:
      uri: ${env:ECR_PROCESSOR_IMAGE_URI}
      command:
        - handlers.processing.video_generator.handle
    architecture: arm64
    timeout: 900  # 15分
    memorySize: 1024  # 1GB（実測値617MB + 余裕）
    environment:
      TEMP_BUCKET: ${self:custom.bucketName}

  # 動画生成API（Web UI用 + Auto-uploader通知）
  generate-video-api:
    image:
      uri: ${env:ECR_PROCESSOR_IMAGE_URI}
      command:
        - handlers.api.generate_video.handle
    architecture: arm64
    timeout: 900  # 15分
    memorySize: 1024
    events:
      - httpApi:
          path: /api/generate-video
          method: post
    environment:
      REPLAYS_BUCKET: ${self:custom.bucketName}
      # 旧テーブル（移行完了後に削除予定）
      REPLAYS_TABLE: ${self:custom.replaysTable}
      # 新バトルテーブル
      CLAN_BATTLES_TABLE: ${self:custom.clanBattlesTable}
      RANKED_BATTLES_TABLE: ${self:custom.rankedBattlesTable}
      RANDOM_BATTLES_TABLE: ${self:custom.randomBattlesTable}
      OTHER_BATTLES_TABLE: ${self:custom.otherBattlesTable}
      NOTIFICATION_CHANNEL_ID: ${env:NOTIFICATION_CHANNEL_ID, ''}

  # リプレイアップロードAPI
  upload-api:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.upload.handle
    architecture: arm64
    timeout: 29  # HTTP API Gatewayの30秒制限より短く設定
    memorySize: 512
    events:
      - httpApi:
          path: /api/upload
          method: post
    environment:
      REPLAYS_BUCKET: ${self:custom.bucketName}
      REPLAYS_TABLE: ${self:custom.replaysTable}
      UPLOAD_API_KEY: ${env:UPLOAD_API_KEY}

  # バトル結果抽出（S3トリガー）
  battle-result-extractor:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.processing.battle_result_extractor.handle
    architecture: arm64
    timeout: 300  # 5分
    memorySize: 512
    events:
      - s3:
          bucket: ${self:custom.bucketName}
          event: s3:ObjectCreated:*
          rules:
            - prefix: replays/
            - suffix: .wowsreplay
          existing: true
    environment:
      # 旧テーブル（移行完了後に削除予定）
      REPLAYS_TABLE: ${self:custom.replaysTable}
      SHIP_MATCH_INDEX_TABLE: ${self:custom.shipMatchIndexTable}
      # 新バトルテーブル
      CLAN_BATTLES_TABLE: ${self:custom.clanBattlesTable}
      RANKED_BATTLES_TABLE: ${self:custom.rankedBattlesTable}
      RANDOM_BATTLES_TABLE: ${self:custom.randomBattlesTable}
      OTHER_BATTLES_TABLE: ${self:custom.otherBattlesTable}
      # 新インデックステーブル
      SHIP_INDEX_TABLE: ${self:custom.shipIndexTable}
      PLAYER_INDEX_TABLE: ${self:custom.playerIndexTable}
      CLAN_INDEX_TABLE: ${self:custom.clanIndexTable}
      STAGE: ${self:provider.stage}
      DEBUG_CAPTAIN_SKILLS: ${self:custom.debugCaptainSkills.${self:provider.stage}, 'false'}

  # 検索API
  search-api:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.search.handle
    architecture: arm64
    timeout: 30
    memorySize: 512  # 最適化: CPU性能向上のため増強
    events:
      - httpApi:
          path: /api/search
          method: post
    environment:
      # 旧テーブル（移行完了後に削除予定）
      REPLAYS_TABLE: ${self:custom.replaysTable}
      SHIP_MATCH_INDEX_TABLE: ${self:custom.shipMatchIndexTable}
      # 新バトルテーブル
      CLAN_BATTLES_TABLE: ${self:custom.clanBattlesTable}
      RANKED_BATTLES_TABLE: ${self:custom.rankedBattlesTable}
      RANDOM_BATTLES_TABLE: ${self:custom.randomBattlesTable}
      OTHER_BATTLES_TABLE: ${self:custom.otherBattlesTable}
      # 新インデックステーブル
      SHIP_INDEX_TABLE: ${self:custom.shipIndexTable}
      PLAYER_INDEX_TABLE: ${self:custom.playerIndexTable}
      CLAN_INDEX_TABLE: ${self:custom.clanIndexTable}

  # 試合詳細API
  match-detail-api:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.match_detail.handle
    architecture: arm64
    timeout: 30
    memorySize: 256
    events:
      - httpApi:
          path: /api/match/{arenaUniqueID}
          method: get
      - httpApi:
          path: /api/match/{arenaUniqueID}/stats
          method: get
    environment:
      # 旧テーブル（移行完了後に削除予定）
      REPLAYS_TABLE: ${self:custom.replaysTable}
      # 新バトルテーブル
      CLAN_BATTLES_TABLE: ${self:custom.clanBattlesTable}
      RANKED_BATTLES_TABLE: ${self:custom.rankedBattlesTable}
      RANDOM_BATTLES_TABLE: ${self:custom.randomBattlesTable}
      OTHER_BATTLES_TABLE: ${self:custom.otherBattlesTable}

  # ========================================
  # 認証API
  # ========================================

  # Discord OAuth2 認証開始
  auth-discord:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.auth.handle_discord_auth
    architecture: arm64
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /api/auth/discord
          method: get
    environment:
      DISCORD_CLIENT_ID: ${env:DISCORD_APPLICATION_ID}
      DISCORD_CLIENT_SECRET: ${env:DISCORD_CLIENT_SECRET}
      FRONTEND_URL: ${env:FRONTEND_URL, ''}
      SESSIONS_TABLE: ${self:custom.sessionsTable}

  # Discord OAuth2 コールバック
  auth-discord-callback:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.auth.handle_discord_callback
    architecture: arm64
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /api/auth/discord/callback
          method: get
    environment:
      DISCORD_CLIENT_ID: ${env:DISCORD_APPLICATION_ID}
      DISCORD_CLIENT_SECRET: ${env:DISCORD_CLIENT_SECRET}
      FRONTEND_URL: ${env:FRONTEND_URL, ''}
      SESSIONS_TABLE: ${self:custom.sessionsTable}
      ALLOWED_GUILD_ID: ${env:ALLOWED_GUILD_ID, ''}
      ALLOWED_ROLE_IDS: ${env:ALLOWED_ROLE_IDS, ''}

  # 現在のユーザー情報取得
  auth-me:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.auth.handle_auth_me
    architecture: arm64
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /api/auth/me
          method: get
    environment:
      SESSIONS_TABLE: ${self:custom.sessionsTable}

  # ログアウト
  auth-logout:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.auth.handle_logout
    architecture: arm64
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /api/auth/logout
          method: post
    environment:
      SESSIONS_TABLE: ${self:custom.sessionsTable}

  # API Key取得
  auth-apikey:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.auth.handle_apikey
    architecture: arm64
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /api/auth/apikey
          method: get
    environment:
      SESSIONS_TABLE: ${self:custom.sessionsTable}
      UPLOAD_API_KEY: ${env:UPLOAD_API_KEY}

  # ========================================
  # ダウンロードAPI
  # ========================================

  # クライアントツールダウンロード
  download-api:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.download.handle
    architecture: arm64
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /api/download
          method: get
    environment:
      TEMP_BUCKET: ${self:custom.bucketName}
      FRONTEND_URL: ${env:FRONTEND_URL}

  # ========================================
  # コメントAPI
  # ========================================

  # コメントCRUD API
  comments-api:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.comments.handle
    architecture: arm64
    timeout: 30
    memorySize: 256
    events:
      - httpApi:
          path: /api/comments/{arenaUniqueID}
          method: get
      - httpApi:
          path: /api/comments/{arenaUniqueID}
          method: post
      - httpApi:
          path: /api/comments/{arenaUniqueID}/{commentId}
          method: put
      - httpApi:
          path: /api/comments/{arenaUniqueID}/{commentId}
          method: delete
      - httpApi:
          path: /api/comments/{arenaUniqueID}/{commentId}/like
          method: post
    environment:
      COMMENTS_TABLE: ${self:custom.commentsTable}
      SESSIONS_TABLE: ${self:custom.sessionsTable}
      # 旧テーブル（移行完了後に削除予定）
      REPLAYS_TABLE: ${self:custom.replaysTable}
      # 新バトルテーブル（コメント数更新用）
      CLAN_BATTLES_TABLE: ${self:custom.clanBattlesTable}
      RANKED_BATTLES_TABLE: ${self:custom.rankedBattlesTable}
      RANDOM_BATTLES_TABLE: ${self:custom.randomBattlesTable}
      OTHER_BATTLES_TABLE: ${self:custom.otherBattlesTable}

# S3バケットは手動で作成済み（wows-replay-bot-dev-temp）
resources:
  Resources:
    # DynamoDBテーブル（リプレイデータ保存用）
    ReplaysTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.replaysTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: arenaUniqueID
            AttributeType: S
          - AttributeName: playerID
            AttributeType: N
          - AttributeName: gameType
            AttributeType: S
          - AttributeName: playerName
            AttributeType: S
          - AttributeName: mapId
            AttributeType: S
          - AttributeName: dateTime
            AttributeType: S
          - AttributeName: dateTimeSortable
            AttributeType: S
        KeySchema:
          - AttributeName: arenaUniqueID
            KeyType: HASH
          - AttributeName: playerID
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: PlayerNameIndex
            KeySchema:
              - AttributeName: playerName
                KeyType: HASH
              - AttributeName: dateTime
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          # 新しいGSI: dateTimeSortable (YYYYMMDDHHMMSS形式) でソート
          # 旧GSI (dateTime = DD.MM.YYYY形式) は年をまたぐと正しくソートされない
          - IndexName: GameTypeSortableIndex
            KeySchema:
              - AttributeName: gameType
                KeyType: HASH
              - AttributeName: dateTimeSortable
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: MapIdSortableIndex
            KeySchema:
              - AttributeName: mapId
                KeyType: HASH
              - AttributeName: dateTimeSortable
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    # DynamoDBテーブル（セッション管理用）
    SessionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.sessionsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: sessionId
            AttributeType: S
        KeySchema:
          - AttributeName: sessionId
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: expiresAt
          Enabled: true

    # DynamoDBテーブル（艦艇-試合インデックス用）
    ShipMatchIndexTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.shipMatchIndexTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: shipName
            AttributeType: S
          - AttributeName: arenaUniqueID
            AttributeType: S
        KeySchema:
          - AttributeName: shipName
            KeyType: HASH
          - AttributeName: arenaUniqueID
            KeyType: RANGE

    # DynamoDBテーブル（コメント用）
    CommentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.commentsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: arenaUniqueID
            AttributeType: S
          - AttributeName: commentId
            AttributeType: S
        KeySchema:
          - AttributeName: arenaUniqueID
            KeyType: HASH
          - AttributeName: commentId
            KeyType: RANGE

    # ========================================
    # 新バトルテーブル（gameType別）
    # ========================================

    # クラン戦テーブル
    ClanBattlesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.clanBattlesTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: arenaUniqueID
            AttributeType: S
          - AttributeName: recordType
            AttributeType: S
          - AttributeName: listingKey
            AttributeType: S
          - AttributeName: unixTime
            AttributeType: N
          - AttributeName: mapId
            AttributeType: S
        KeySchema:
          - AttributeName: arenaUniqueID
            KeyType: HASH
          - AttributeName: recordType
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: ListingIndex
            KeySchema:
              - AttributeName: listingKey
                KeyType: HASH
              - AttributeName: unixTime
                KeyType: RANGE
            Projection:
              ProjectionType: INCLUDE
              NonKeyAttributes:
                - arenaUniqueID
                - dateTime
                - mapId
                - mapDisplayName
                - winLoss
                - allyMainClanTag
                - enemyMainClanTag
                - uploaders
                - commentCount
                - dualRendererAvailable
          - IndexName: MapIndex
            KeySchema:
              - AttributeName: mapId
                KeyType: HASH
              - AttributeName: unixTime
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY

    # ランク戦テーブル
    RankedBattlesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.rankedBattlesTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: arenaUniqueID
            AttributeType: S
          - AttributeName: recordType
            AttributeType: S
          - AttributeName: listingKey
            AttributeType: S
          - AttributeName: unixTime
            AttributeType: N
          - AttributeName: mapId
            AttributeType: S
        KeySchema:
          - AttributeName: arenaUniqueID
            KeyType: HASH
          - AttributeName: recordType
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: ListingIndex
            KeySchema:
              - AttributeName: listingKey
                KeyType: HASH
              - AttributeName: unixTime
                KeyType: RANGE
            Projection:
              ProjectionType: INCLUDE
              NonKeyAttributes:
                - arenaUniqueID
                - dateTime
                - mapId
                - mapDisplayName
                - winLoss
                - allyMainClanTag
                - enemyMainClanTag
                - uploaders
                - commentCount
                - dualRendererAvailable
          - IndexName: MapIndex
            KeySchema:
              - AttributeName: mapId
                KeyType: HASH
              - AttributeName: unixTime
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY

    # ランダム戦テーブル
    RandomBattlesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.randomBattlesTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: arenaUniqueID
            AttributeType: S
          - AttributeName: recordType
            AttributeType: S
          - AttributeName: listingKey
            AttributeType: S
          - AttributeName: unixTime
            AttributeType: N
          - AttributeName: mapId
            AttributeType: S
        KeySchema:
          - AttributeName: arenaUniqueID
            KeyType: HASH
          - AttributeName: recordType
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: ListingIndex
            KeySchema:
              - AttributeName: listingKey
                KeyType: HASH
              - AttributeName: unixTime
                KeyType: RANGE
            Projection:
              ProjectionType: INCLUDE
              NonKeyAttributes:
                - arenaUniqueID
                - dateTime
                - mapId
                - mapDisplayName
                - winLoss
                - allyMainClanTag
                - enemyMainClanTag
                - uploaders
                - commentCount
                - dualRendererAvailable
          - IndexName: MapIndex
            KeySchema:
              - AttributeName: mapId
                KeyType: HASH
              - AttributeName: unixTime
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY

    # その他バトルテーブル
    OtherBattlesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.otherBattlesTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: arenaUniqueID
            AttributeType: S
          - AttributeName: recordType
            AttributeType: S
          - AttributeName: listingKey
            AttributeType: S
          - AttributeName: unixTime
            AttributeType: N
          - AttributeName: mapId
            AttributeType: S
        KeySchema:
          - AttributeName: arenaUniqueID
            KeyType: HASH
          - AttributeName: recordType
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: ListingIndex
            KeySchema:
              - AttributeName: listingKey
                KeyType: HASH
              - AttributeName: unixTime
                KeyType: RANGE
            Projection:
              ProjectionType: INCLUDE
              NonKeyAttributes:
                - arenaUniqueID
                - dateTime
                - mapId
                - mapDisplayName
                - winLoss
                - allyMainClanTag
                - enemyMainClanTag
                - uploaders
                - commentCount
                - dualRendererAvailable
          - IndexName: MapIndex
            KeySchema:
              - AttributeName: mapId
                KeyType: HASH
              - AttributeName: unixTime
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY

    # ========================================
    # 新インデックステーブル
    # ========================================

    # 艦艇インデックステーブル
    ShipIndexTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.shipIndexTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: shipName
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: shipName
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE

    # プレイヤーインデックステーブル
    PlayerIndexTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.playerIndexTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: playerName
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: playerName
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE

    # クランインデックステーブル
    ClanIndexTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.clanIndexTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: clanTag
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: clanTag
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE

# Dockerイメージを使用するため、pluginsは不要
# plugins:
#   - serverless-python-requirements

# Outputs
outputs:
  InteractionsEndpoint:
    Description: Discord Interactions Webhook URL
    Value:
      Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/interactions
