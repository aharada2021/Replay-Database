service: wows-replay-bot

frameworkVersion: '3'

provider:
  name: aws
  region: ap-northeast-1
  # Dockerイメージを使用する場合、runtimeは不要（個別関数で指定）
  stage: ${opt:stage, 'dev'}

  # HTTP API CORS設定
  httpApi:
    cors:
      allowedOrigins:
        - https://wows-replay.mirage0926.com
        - http://localhost:3000
      allowedHeaders:
        - Content-Type
        - X-Api-Key
        - X-User-Id
        - Cookie
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: true

  # 環境変数
  environment:
    DISCORD_PUBLIC_KEY: ${env:DISCORD_PUBLIC_KEY}
    DISCORD_APPLICATION_ID: ${env:DISCORD_APPLICATION_ID}
    DISCORD_BOT_TOKEN: ${env:DISCORD_BOT_TOKEN}
    INPUT_CHANNEL_ID: ${env:INPUT_CHANNEL_ID}
    GUILD_ID: ${env:GUILD_ID}
    STAGE: ${self:provider.stage}

  # IAMロール
  iam:
    role:
      statements:
        # S3アクセス（一時ファイル保存用）
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
          Resource:
            - arn:aws:s3:::${self:custom.bucketName}/*

        # CloudWatch Logs
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'

        # Lambda呼び出し
        # interactions → replay-analyzer → video-generator
        # battle-result-extractor → generate-video-api
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource:
            - arn:aws:lambda:${self:provider.region}:*:function:${self:service}-${self:provider.stage}-replay-analyzer
            - arn:aws:lambda:${self:provider.region}:*:function:${self:service}-${self:provider.stage}-video-generator
            - arn:aws:lambda:${self:provider.region}:*:function:${self:service}-${self:provider.stage}-generate-video-api

        # DynamoDB アクセス
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            - dynamodb:Scan
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.replaysTable}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.replaysTable}/index/*
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.sessionsTable}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.shipMatchIndexTable}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.shipMatchIndexTable}/index/*

# カスタム変数
custom:
  bucketName: wows-replay-bot-${self:provider.stage}-temp
  replaysTable: wows-replays-${self:provider.stage}
  sessionsTable: wows-sessions-${self:provider.stage}
  shipMatchIndexTable: wows-ship-match-index-${self:provider.stage}
  # Dockerイメージを使用するため、pythonRequirementsは不要
  # pythonRequirements:
  #   dockerizePip: true
  #   layer: true

functions:
  # ========================================
  # Extractorイメージを使用する関数群（メタデータ解析など）
  # ========================================

  # Discord Interactions Endpoint
  interactions:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.discord.interactions.handle_interaction
    architecture: arm64
    timeout: 30  # 30秒（軽量な処理のみ）
    memorySize: 256  # 256MB（コマンド受信と非同期呼び出しのみ）
    events:
      - httpApi:
          path: /interactions
          method: post
    environment:
      TEMP_BUCKET: ${self:custom.bucketName}
      REPLAY_ANALYZER_FUNCTION_NAME: ${self:service}-${self:provider.stage}-replay-analyzer

  # リプレイ解析用Lambda関数（extractor環境）
  replay-analyzer:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.processing.replay_analyzer.handle
    architecture: arm64
    timeout: 300  # 5分（メタデータ解析のみ）
    memorySize: 512
    environment:
      TEMP_BUCKET: ${self:custom.bucketName}
      VIDEO_GENERATOR_FUNCTION_NAME: ${self:service}-${self:provider.stage}-video-generator

  # ========================================
  # Processorイメージを使用する関数群（renderer依存）
  # ========================================

  # 動画生成用Lambda関数（processor環境）
  video-generator:
    image:
      uri: ${env:ECR_PROCESSOR_IMAGE_URI}
      command:
        - handlers.processing.video_generator.handle
    architecture: arm64
    timeout: 900  # 15分
    memorySize: 1024  # 1GB（実測値617MB + 余裕）
    environment:
      TEMP_BUCKET: ${self:custom.bucketName}

  # 動画生成API（Web UI用）
  generate-video-api:
    image:
      uri: ${env:ECR_PROCESSOR_IMAGE_URI}
      command:
        - handlers.api.generate_video.handle
    architecture: arm64
    timeout: 900  # 15分
    memorySize: 1024
    events:
      - httpApi:
          path: /api/generate-video
          method: post
    environment:
      REPLAYS_BUCKET: ${self:custom.bucketName}
      REPLAYS_TABLE: ${self:custom.replaysTable}

  # リプレイアップロードAPI
  upload-api:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.upload.handle
    architecture: arm64
    timeout: 60
    memorySize: 512
    events:
      - httpApi:
          path: /api/upload
          method: post
    environment:
      REPLAYS_BUCKET: ${self:custom.bucketName}
      REPLAYS_TABLE: ${self:custom.replaysTable}
      UPLOAD_API_KEY: ${env:UPLOAD_API_KEY}

  # バトル結果抽出（S3トリガー - S3通知は手動設定済み）
  battle-result-extractor:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.processing.battle_result_extractor.handle
    architecture: arm64
    timeout: 300  # 5分
    memorySize: 512
    # S3トリガーは既に手動設定済み（wows-replay-bot-dev-temp/replays/*.wowsreplay）
    environment:
      REPLAYS_TABLE: ${self:custom.replaysTable}
      SHIP_MATCH_INDEX_TABLE: ${self:custom.shipMatchIndexTable}
      STAGE: ${self:provider.stage}

  # 検索API
  search-api:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.search.handle
    architecture: arm64
    timeout: 30
    memorySize: 256
    events:
      - httpApi:
          path: /api/search
          method: post
    environment:
      REPLAYS_TABLE: ${self:custom.replaysTable}
      SHIP_MATCH_INDEX_TABLE: ${self:custom.shipMatchIndexTable}

  # 試合詳細API
  match-detail-api:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.match_detail.handle
    architecture: arm64
    timeout: 30
    memorySize: 256
    events:
      - httpApi:
          path: /api/match/{arenaUniqueID}
          method: get
    environment:
      REPLAYS_TABLE: ${self:custom.replaysTable}

  # ========================================
  # 認証API
  # ========================================

  # Discord OAuth2 認証開始
  auth-discord:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.auth.handle_discord_auth
    architecture: arm64
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /api/auth/discord
          method: get
    environment:
      DISCORD_CLIENT_ID: ${env:DISCORD_APPLICATION_ID}
      DISCORD_CLIENT_SECRET: ${env:DISCORD_CLIENT_SECRET}
      FRONTEND_URL: ${env:FRONTEND_URL, 'https://wows-replay.mirage0926.com'}
      SESSIONS_TABLE: ${self:custom.sessionsTable}

  # Discord OAuth2 コールバック
  auth-discord-callback:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.auth.handle_discord_callback
    architecture: arm64
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /api/auth/discord/callback
          method: get
    environment:
      DISCORD_CLIENT_ID: ${env:DISCORD_APPLICATION_ID}
      DISCORD_CLIENT_SECRET: ${env:DISCORD_CLIENT_SECRET}
      FRONTEND_URL: ${env:FRONTEND_URL, 'https://wows-replay.mirage0926.com'}
      SESSIONS_TABLE: ${self:custom.sessionsTable}
      ALLOWED_GUILD_ID: ${env:ALLOWED_GUILD_ID, '1457376632921788550'}

  # 現在のユーザー情報取得
  auth-me:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.auth.handle_auth_me
    architecture: arm64
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /api/auth/me
          method: get
    environment:
      SESSIONS_TABLE: ${self:custom.sessionsTable}

  # ログアウト
  auth-logout:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.auth.handle_logout
    architecture: arm64
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /api/auth/logout
          method: post
    environment:
      SESSIONS_TABLE: ${self:custom.sessionsTable}

  # API Key取得
  auth-apikey:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.auth.handle_apikey
    architecture: arm64
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /api/auth/apikey
          method: get
    environment:
      SESSIONS_TABLE: ${self:custom.sessionsTable}
      UPLOAD_API_KEY: ${env:UPLOAD_API_KEY}

  # ========================================
  # ダウンロードAPI
  # ========================================

  # クライアントツールダウンロード
  download-api:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - handlers.api.download.handle
    architecture: arm64
    timeout: 10
    memorySize: 256
    events:
      - httpApi:
          path: /api/download
          method: get
    environment:
      TEMP_BUCKET: ${self:custom.bucketName}

# S3バケットは手動で作成済み（wows-replay-bot-dev-temp）
resources:
  Resources:
    # DynamoDBテーブル（リプレイデータ保存用）
    ReplaysTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.replaysTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: arenaUniqueID
            AttributeType: S
          - AttributeName: playerID
            AttributeType: N
          - AttributeName: gameType
            AttributeType: S
          - AttributeName: playerName
            AttributeType: S
          - AttributeName: mapId
            AttributeType: S
          - AttributeName: dateTime
            AttributeType: S
        KeySchema:
          - AttributeName: arenaUniqueID
            KeyType: HASH
          - AttributeName: playerID
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GameTypeIndex
            KeySchema:
              - AttributeName: gameType
                KeyType: HASH
              - AttributeName: dateTime
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: PlayerNameIndex
            KeySchema:
              - AttributeName: playerName
                KeyType: HASH
              - AttributeName: dateTime
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: MapIdIndex
            KeySchema:
              - AttributeName: mapId
                KeyType: HASH
              - AttributeName: dateTime
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    # DynamoDBテーブル（セッション管理用）
    SessionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.sessionsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: sessionId
            AttributeType: S
        KeySchema:
          - AttributeName: sessionId
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: expiresAt
          Enabled: true

    # DynamoDBテーブル（艦艇-試合インデックス用）
    ShipMatchIndexTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.shipMatchIndexTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: shipName
            AttributeType: S
          - AttributeName: arenaUniqueID
            AttributeType: S
        KeySchema:
          - AttributeName: shipName
            KeyType: HASH
          - AttributeName: arenaUniqueID
            KeyType: RANGE

# Dockerイメージを使用するため、pluginsは不要
# plugins:
#   - serverless-python-requirements

# Outputs
outputs:
  InteractionsEndpoint:
    Description: Discord Interactions Webhook URL
    Value:
      Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/interactions
