service: wows-replay-bot

frameworkVersion: '3'

provider:
  name: aws
  region: ap-northeast-1
  # Dockerイメージを使用する場合、runtimeは不要（個別関数で指定）
  stage: ${opt:stage, 'dev'}

  # HTTP API CORS設定
  httpApi:
    cors:
      allowedOrigins:
        - '*'
      allowedHeaders:
        - Content-Type
        - X-Api-Key
        - X-User-Id
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: false

  # 環境変数
  environment:
    DISCORD_PUBLIC_KEY: ${env:DISCORD_PUBLIC_KEY}
    DISCORD_APPLICATION_ID: ${env:DISCORD_APPLICATION_ID}
    DISCORD_BOT_TOKEN: ${env:DISCORD_BOT_TOKEN}
    INPUT_CHANNEL_ID: ${env:INPUT_CHANNEL_ID}
    GUILD_ID: ${env:GUILD_ID}
    STAGE: ${self:provider.stage}

  # IAMロール
  iam:
    role:
      statements:
        # S3アクセス（一時ファイル保存用）
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
          Resource:
            - arn:aws:s3:::${self:custom.bucketName}/*

        # CloudWatch Logs
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'

        # Lambda呼び出し（interactions → processor, battle-result-extractor → generate-video-api）
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource:
            - arn:aws:lambda:${self:provider.region}:*:function:${self:service}-${self:provider.stage}-processor
            - arn:aws:lambda:${self:provider.region}:*:function:${self:service}-${self:provider.stage}-generate-video-api

        # DynamoDB アクセス
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            - dynamodb:Scan
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.replaysTable}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.replaysTable}/index/*

# カスタム変数
custom:
  bucketName: wows-replay-bot-${self:provider.stage}-temp
  replaysTable: wows-replays-${self:provider.stage}
  # Dockerイメージを使用するため、pythonRequirementsは不要
  # pythonRequirements:
  #   dockerizePip: true
  #   layer: true

functions:
  # ========================================
  # Processorイメージを使用する関数群
  # ========================================

  # Discord Interactions Endpoint
  interactions:
    image:
      uri: ${env:ECR_PROCESSOR_IMAGE_URI}
      command:
        - lambda_handler.handle_interaction
    architecture: arm64
    timeout: 30  # 30秒（軽量な処理のみ）
    memorySize: 256  # 256MB（コマンド受信と非同期呼び出しのみ）
    events:
      - httpApi:
          path: /interactions
          method: post
    environment:
      TEMP_BUCKET: ${self:custom.bucketName}
      PROCESSOR_FUNCTION_NAME: ${self:service}-${self:provider.stage}-processor

  # リプレイ処理用Lambda関数
  processor:
    image:
      uri: ${env:ECR_PROCESSOR_IMAGE_URI}
      command:
        - replay_processor_handler.handle_replay_processing
    architecture: arm64
    timeout: 900  # 15分
    memorySize: 1024  # 1GB（実測値617MB + 余裕）
    environment:
      TEMP_BUCKET: ${self:custom.bucketName}

  # 動画生成API
  generate-video-api:
    image:
      uri: ${env:ECR_PROCESSOR_IMAGE_URI}
      command:
        - generate_video_api_handler.handle
    architecture: arm64
    timeout: 900  # 15分
    memorySize: 1024
    events:
      - httpApi:
          path: /api/generate-video
          method: post
    environment:
      REPLAYS_BUCKET: ${self:custom.bucketName}
      REPLAYS_TABLE: ${self:custom.replaysTable}

  # ========================================
  # Extractorイメージを使用する関数群
  # ========================================

  # リプレイアップロードAPI
  upload-api:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - upload_api_handler.handle
    architecture: arm64
    timeout: 60
    memorySize: 512
    events:
      - httpApi:
          path: /api/upload
          method: post
    environment:
      REPLAYS_BUCKET: ${self:custom.bucketName}
      REPLAYS_TABLE: ${self:custom.replaysTable}
      UPLOAD_API_KEY: ${env:UPLOAD_API_KEY}

  # バトル結果抽出（S3トリガー）
  battle-result-extractor:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - battle_result_extractor_handler.handle
    architecture: arm64
    timeout: 300  # 5分
    memorySize: 512
    environment:
      REPLAYS_TABLE: ${self:custom.replaysTable}

  # 検索API
  search-api:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - search_api_handler.handle
    architecture: arm64
    timeout: 30
    memorySize: 256
    events:
      - httpApi:
          path: /api/search
          method: post
    environment:
      REPLAYS_TABLE: ${self:custom.replaysTable}

  # 試合詳細API
  match-detail-api:
    image:
      uri: ${env:ECR_EXTRACTOR_IMAGE_URI}
      command:
        - match_detail_api_handler.handle
    architecture: arm64
    timeout: 30
    memorySize: 256
    events:
      - httpApi:
          path: /api/match/{arenaUniqueID}
          method: get
    environment:
      REPLAYS_TABLE: ${self:custom.replaysTable}

# S3バケットは手動で作成済み（wows-replay-bot-dev-temp）
resources:
  Resources:
    # DynamoDBテーブル（リプレイデータ保存用）
    ReplaysTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.replaysTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: arenaUniqueID
            AttributeType: S
          - AttributeName: playerID
            AttributeType: N
          - AttributeName: gameType
            AttributeType: S
          - AttributeName: playerName
            AttributeType: S
          - AttributeName: mapId
            AttributeType: S
          - AttributeName: dateTime
            AttributeType: S
        KeySchema:
          - AttributeName: arenaUniqueID
            KeyType: HASH
          - AttributeName: playerID
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GameTypeIndex
            KeySchema:
              - AttributeName: gameType
                KeyType: HASH
              - AttributeName: dateTime
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: PlayerNameIndex
            KeySchema:
              - AttributeName: playerName
                KeyType: HASH
              - AttributeName: dateTime
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: MapIdIndex
            KeySchema:
              - AttributeName: mapId
                KeyType: HASH
              - AttributeName: dateTime
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

# Dockerイメージを使用するため、pluginsは不要
# plugins:
#   - serverless-python-requirements

# Outputs
outputs:
  InteractionsEndpoint:
    Description: Discord Interactions Webhook URL
    Value:
      Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/interactions
